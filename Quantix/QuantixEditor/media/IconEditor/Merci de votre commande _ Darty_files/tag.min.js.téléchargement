/*! Copyright (c) 2020 Mediarithmics; All Rights Reserved */

!function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={exports:{},id:n,loaded:!1};return t[n].call(o.exports,o,o.exports,i),o.loaded=!0,o.exports}i.m=t,i.c=e,i.p="",i(0)}([function(t,e,i){i(1),i(5),i(2),i(6),i(4),i(3),i(7),i(8),i(9),function(t){"use strict";var e=window.navigator.userAgent;if(!/googlebot|bingbot|yandexbot|baiduspider/i.test(e)){var n=!1,o=null,s=(new Date).getTime(),r=i(8),a=(0,i(6).readCookie)("mics_debug_tag"),c=i(2)("tag",a),h=i(3).mics;if(h._tagVersion)return c.warn("The tag was already loaded, aborting."),void l();h._tagVersion="1.2.13",h._reset=function(t){n&&!t||(n=!0,c.info("mics.reset"),u(function(t){h[t]._reset()}),h._token=null,h._initialized=!1,o&&(o.clearWatchDog(),o=null),h._startTime||(h._startTime=s))},h._setConfig=function(t){c.info("mics._setConfig",t),u(function(e){h[e].setConfig(t)})},window.mics=window.mics||{},window.mics._setConfig=h._setConfig,window.mics._tagVersion="1.2.13",h._setOperatorId=function(t,e){u(function(i){h[i].setOperatorId(t,e)})},h._setUAID=function(t,e,i){u(function(n){h[n]._setUAID(t,e,i)})},l(),window.addEventListener&&window.addEventListener("beforeunload",function(){u(function(t){h[t].pageQuit()})},!1)}function u(t){for(var e=0;e<h._names.length;e++)t(h._names[e])}function l(){var t=h._queue||{};u(function(t){h[t]&&h[t].context||(h[t]=new r(t,a),window[t]=h[t],"mics"===t&&(h[t]._setConfig=h._setConfig))}),u(function(e){!function(t,e){for(;e.length;){var i=e.shift();c.debug("executing ",i,"on",t),h[t].callMicsMethod(i.method,i.args)}}(e,t[e])})}}()},function(t,e,i){!function(e){"use strict";var n=i(4);t.exports=function(t,e,n,o){this.finished=!1,this.ran=!1,this.operators=t,this.retrievedIds=[],this.timeout=e,this.watchDog=null,this.options=o,this.console=i(2)("CookieMatcher",n)},t.exports.prototype={end:function(){return this.gatherIdEnd},panicCallback:function(t){this.panicFn=t},gatherOperatorsIds:function(){this.console.info("gatherOperatorsIds",this.operators);for(var t=0;t<this.operators.length;t++)this.gatherId(this.operators[t]);var e=this;this.timeout>0&&(this.watchDog=window.setTimeout(function(){e._timeout()},this.timeout))},setEtid:function(t){this.etid=t,this.finishIfPossible()},gatherId:function(t){var e=this;n.loadScript(this.options.gather_operator_id_url+"?opid="+t,function(i){i&&(e.console.info("error while gather_id",t),e.setOperatorId(t,null))})},setOperatorId:function(t,e){(function(t,e){for(var i=0;i<t.length;i++)if(t[i]===e)return!0;return!1})(this.retrievedIds,e)||(this.console.log("setId("+t+", "+e+")"),this.retrievedIds.push(e),this.finished=this.retrievedIds.length===this.operators.length,this.finishIfPossible())},finishIfPossible:function(t){var e=this;if(e.console.log("try to finish, panicMode:",e.panicMode,"etid:",e.etid,"finished",e.retrievedIds.length),e.finished||t){e.gatherIdEnd=(new Date).getTime();for(var i=[];e.retrievedIds.length;){var o=e.retrievedIds.shift();o&&i.push(o)}e.console.log("finishing.");var s=e.options.cookie_matching_url+"?";e.etid&&(s=s+"etid="+e.etid+"&"),e.options.site_token&&(s=s+"$site_token="+e.options.site_token+"&"),e.options.datamart_token&&(s=s+"$dat_token="+e.options.datamart_token+"&"),s=s+"utidl="+i.join(","),n.loadScript(s,function(t){t&&e.panicFn&&(e.console.info("failed to load get_id"),e.panicFn("$get_id_failed"))}),e.ran=!0,e.destroy()}},_timeout:function(){this.finishIfPossible(!0)},destroy:function(){window.clearTimeout(this.watchDog)}}}()},function(t,e,i){!function(e){"use strict";var n=i(3);t.exports=function(t,e){return function(i){var o={};function s(i){return function(){if(e&&window.console&&window.console[i])try{var o=Array.prototype.slice.apply(arguments),s=n.durationFromSnippetStart((new Date).getTime())/1e3;o.unshift(t),o.unshift("mics "+s.toFixed(3)+" s"),window.console[i].apply(window.console,o)}catch(t){}}}for(var r=0;r<i.length;r++)o[i[r]]=s(i[r]);return o}("log debug info warn error".split(" "))}}()},function(t,e,i){!function(){"use strict";var e=window.scimhtiraidem;if(window.mics&&window.mics._snippetVersion&&(window.scimhtiraidem||((e=window.scimhtiraidem={})._queue={},e._names=[]),e._queue.mics=window.mics._queue,e._snippetVersion=e._snippetVersion||window.mics._snippetVersion,e._startTime=window.mics._startTime,e._names.push("mics"),e.mics=window.mics),!e)throw new Error("mics is not defined. Did you used the provided snippet ?");t.exports.mics=e,t.exports.durationFromSnippetStart=function(t){return t?t-e._startTime:null}}()},function(t,e,i){!function(){"use strict";e.loadPixel=function(t,e){var i=document.createElement("img");i.style.display="none",i.style.width=i.style.height="0px",e&&(i.onload=function(){e(null,t)},i.onerror=function(){var i=new Error("error while loading "+t);i.url=t,e(i,null)}),i.setAttribute("src",t)},e.loadScript=function(t,e){var i=document.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src",t),i.setAttribute("async","true"),e&&(i.onload=function(){e(null,t)},i.onerror=function(){var i=new Error("error while loading"+t);i.url=t,e(i,null)}),document.getElementsByTagName("script")[0].parentNode.appendChild(i)},e.get=function(t,e){var i=new XMLHttpRequest;i.onreadystatechange=function(n){if(4===this.readyState)if(200===this.status)e(null,i.responseText);else{var o=new Error("error while GETting: "+t);o.url=t,e(o,null)}},i.open("GET",t,!0),i.withCredentials=!0,i.send(null)}}()},function(t,e,i){!function(e){"use strict";var n=i(6).readCookie;t.exports=function(t){this.properties={},this.options=t,this.ready=!1},t.exports.prototype={_parseSearch:function(t){for(var e,i,n,o=t.substring(1).split("&"),s={},r=0;r<o.length;r++)i=(e=o[r].split("="))[0],n=e[1],s[i]=decodeURIComponent(n).replace(/\+/g," ");return s},_setReady:function(){this.ready=!0},isReady:function(){return this.ready},readPage:function(){this.properties.$referrer=document.referrer,this.properties.$url=""+document.location;for(var t="utm_source utm_medium utm_term utm_content utm_campaign".split(" "),e=this._parseSearch(window.location.search),i=0;i<t.length;i++){var o=t[i];e[o]&&(this.properties["$"+o]=e[o])}if(this.options.local_cookie_name){var s=n(this.options.local_cookie_name);s&&(this.properties.raw_cookie=s)}var r=n("mics_uaid");r&&(this.properties.$uaid=r);var a=n("mics_vid");a&&(this.properties.$vid=a);var c=parseInt(n("mics_lts"),10);isNaN(c)||(this.properties.$lts=c)},getVid:function(){return this.properties.$vid},getLts:function(){return this.properties.$lts},getCookie:function(){return this.properties.$uaid},updateUAID:function(t,e){var i=new Date;i.setTime(i.getTime()+24*this.options.cookie_max_age_in_days*60*60*1e3),t&&(this.properties.$vid=t,document.cookie="mics_vid="+encodeURIComponent(t)+";expires="+i.toGMTString()+";path=/"),e&&(this.properties.$lts=e,document.cookie="mics_lts="+encodeURIComponent(e)+";expires="+i.toGMTString()+";path=/"),this._setReady()}}}()},function(t,e,i){!function(t){"use strict";var n=i(2)("CookieReader",!1);e.readCookie=function(t){for(var e=document.cookie.split(";"),i=0;i<e.length;i++){var o=e[i].replace(/ /g,"").split("=");if(o[0]===t)return n.debug("found cookie",o[0],o[1]),o[1]}return null}}()},function(t,e,i){!function(e){"use strict";function n(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}var o={$user_account_id:"$cuid"},s=i(3),r=i(4);t.exports=function(t,e,n,o,s){this.console=i(2)("EventPusher-"+t,s.debug),this.console.info("new EventPusher()"),this.callQueue=[],this.currentPage=n,this.transportFunction=s.override_transport,this.cookieMatcher=o,this.tagStart=e,this.globalProperties={},this.eventsRunning=0,this.endPointUrl=s.end_point_url,this.panicMode=!1,this.errorEvents=[]},t.exports.prototype={sendCallQueue:function(t,e){for(var i=this.callQueue,o=e||{};i.length;){var r=s.durationFromSnippetStart((new Date).getTime());r&&(o.$delay={$push:r,$start:s.durationFromSnippetStart(this.tagStart),$gather_id_end:s.durationFromSnippetStart(this.cookieMatcher.end()),$beacon:t===this.beacon});var a=i.shift();a=n(a=n(a=n(a,this.currentPage.properties),this.globalProperties),o),this.console.info("pushing",a);var c=this.endPointUrl+"?"+this.generateHttpQuery(a);this.eventsRunning++,t(c,this.pixelSentCallback(this))}this.panicMode||(this.console.info("complete before panicMode, clearing watchDog"),this.clearWatchDog())},clearWatchDog:function(){this.watchDog&&(this.console.log("clearing watchdog"),window.clearTimeout(this.watchDog),this.watchDog=null)},setWatchDog:function(t){this.console.info("setup watchdog timer to ",t),this.clearWatchDog();var e=this;this.watchDog=setTimeout(function(){e.panic("$count_down_1")},t)},setPanicCallback:function(t){this.panicFn=t},triggerCallsIfPossible:function(){if(this.console.info("trigger calls if possible: currentPage:",this.currentPage,"panicMode:",this.panicMode,", global:",this.globalProperties,"callQueue:",this.callQueue),this.currentPage&&this.currentPage.isReady()||this.panicMode){var t={};this.panicMode&&(t.$error=this.panicReason),this.sendCallQueue(this.transportFunction||r.loadPixel,t)}},pixelSentCallback:function(t){return function(e,i){if(e?(t.eventsRunning--,t.console.info("error with",e)):(t.console.info("successfully sent",i),t.eventsRunning--),t.finishedCallbackFunction&&0===t.eventsRunning){t.console.info("calling callback function: eventsRunning:",t.eventsRunning,"errors:",t.errorEvents);try{t.finishedCallbackFunction.apply(0===t.errorEvents.length)}catch(e){t.console.error("error has occurred while calling callback function",e)}}}},pushDefault:function(){this.push("$page_view")},push:function(t,e){if(!this.currentPage)throw new Error("mics is not initialized, call mics.init(YOUR_TOKEN) first !");(e=e||{}).$ev=t,this.callQueue.push(e),this.triggerCallsIfPossible()},addProperties:function(t){this.globalProperties=n(this.globalProperties,t),this.console.info("properties: ",this.globalProperties)},generateHttpQuery:function(t){var e=[];for(var i in t)if(t.hasOwnProperty(i)&&"object"!=typeof t[i]){var n=o[i]||i;e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[i]))}else if("object"==typeof t[i]&&"object"==typeof JSON){var s=o[i]||i;e.push(encodeURIComponent(s)+"=jso-"+encodeURIComponent(JSON.stringify(t[i])))}return e.join("&")},panic:function(t){this.console.info("switching to panic mode ! reason:",t),this.panicMode=!0,this.panicReason=t,this.triggerCallsIfPossible()},onFinish:function(t,e){this.finishedCallbackFunction=t,this.setWatchDog(e)},beacon:function(t){navigator.sendBeacon(t)},pageQuit:function(){if(this.console.log("page is unloading"),navigator.sendBeacon){for(this.console.log("send call queue with navigator.beacon ("+this.errorEvents.length+" events)");this.errorEvents.length;)this.beacon(this.errorEvents.shift());this.eventsRunning>0&&this.push("$quit_while_running"),this.sendCallQueue(this.beacon,{$error:"page_quit"})}}}}()},function(t,e,i){!function(e){"use strict";function n(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}var o=function(){var t,e=["init","call","config","push","pushDefault","addProperties","addProperty","onFinish","onStart","_reset","syncFeeds"],i=[],n={};for(t=0;t<e.length;t++)n[e[t]]=!0;for(t=0;t<i.length;t++)n[i[t]]=!0;return n}(),s=(new Date).getTime(),r=i(1),a=i(5),c=i(4),h=i(7),u=i(9),l=i(3).mics,d={domain_id:1,cookie_matching_url:"https://cookie-matching.mediarithmics.com/v1/getids",gather_operator_id_url:"https://cookie-matching.mediarithmics.com/v1/gather_id",get_id_path:"/v1/get_id",domain_name:"events.mediarithmics.com",protocol:"https://",events_path:"/v1/visits/pixel",config_server_url:"https://events.mediarithmics.com/v1/conf.js",cookie_max_age_in_days:365,cookie_refresh_in_days:10,local_cookie_name:null,gather_id_timeout_ms:2e3,global_timeout_ms:3e3,override_transport:null};t.exports=function(t,e){this.console=i(2)(t,e),this.cookieMatcher=null,this.eventPusher=null,this.currentPage=null,this.context=t,this.options=n({debug:e},d),this.globalProperties={$sv:l._snippetVersion},this.console.info("creating tag object",this.globalProperties)},t.exports.prototype={fetchConfig:function(){c.loadScript(this.options.config_server_url)},call:function(t){var e=Array.prototype.slice.apply(arguments).splice(1);this.callMicsMethod(t,e)},callMicsMethod:function(t,e){o[t]?this[t].apply(this,e):this.console.error("The method '"+t+"' is not supported.")},onStart:function(t){t&&t.apply()},setOperatorId:function(t,e){this.cookieMatcher&&this.cookieMatcher.setOperatorId(t,e)},fetchUAID:function(t,e,i){var n=new Date;if(n.setTime(n.getTime()-24*this.options.cookie_refresh_in_days*60*60*1e3),e&&i>n.getTime()){var o=this;setTimeout(function(){o._setUAID(t,e,i)},0)}else this.cookieMatcher.gatherOperatorsIds()},clearWatchDog:function(){this.eventPusher.clearWatchDog()},setConfig:function(t){this.currentPage&&(this.console.info("setConfig",t),this.addProperties({$etid:t.etid,$audience_feeds_refresh_period:t.audience_feeds_refresh_period}),this.cookieMatcher.setEtid(t.etid),this.eventPusher.triggerCallsIfPossible())},_setUAID:function(t,e,i){this.currentPage&&(e&&!this.set&&(this.set=!0,this.console.log("_setUAID(",e,i,")"),this.currentPage.updateUAID(e,i)),this.eventPusher.triggerCallsIfPossible())},init:function(t){if(void 0===t)throw new Error(this.context+".init : use a token string or an object");var e=null;e=n(this.options,"string"==typeof t?{mode:"VISIT",site_token:t,domain_name:this.options.domain_name}:t),t.cookie_matching_url?this.console.info("overriding cookie_matching_url with ",t.cookie_matching_url):t.domain_name&&(e.cookie_matching_url=e.protocol+e.domain_name+e.get_id_path,this.console.info("using custom domain, cookie_matching_url will be ",e.cookie_matching_url)),this.console.info("mcsObj.config, new configuration is",e),this.options=e;var i=null,o=null;if("VISIT"===e.mode)i="/v1/visits/pixel",o=this.globalProperties.$site_token=e.site_token;else{if("TOUCH"!==e.mode)throw new Error(this.context+".init : invalid mode ("+e.mode+")");i="/v1/touches/pixel",o=this.globalProperties.$dat_token=e.datamart_token}if(null===this.eventPusher){if("string"!=typeof o)throw new Error(this.context+".init : the token must be a string");if(0===o.length)throw new Error(this.context+".init : the token must be a non-empty string");this.currentPage=new a(e),this.cookieMatcher=new r(["goo","apx"],e.gather_id_timeout_ms,e.debug,e),this.currentPage.readPage(),this.fetchUAID(this.currentPage.getCookie(),this.currentPage.getVid(),this.currentPage.getLts());var c={end_point_url:e.protocol+e.domain_name+i,debug:e.debug,override_transport:e.override_transport};this.eventPusher=new h(this.context,s,this.currentPage,this.cookieMatcher,c),this.eventPusher.addProperties(this.globalProperties),this.eventPusher.setWatchDog(e.global_timeout_ms),this.cookieMatcher.panicCallback(this.eventPusher.panic),this.addProperty("$tv","1.2.13")}else this.console.warn(this.context+" was already initialized, stop initialization")},pageQuit:function(){this.eventPusher&&this.eventPusher.pageQuit()},onFinish:function(t,e){this.eventPusher.onFinish(t,e)},pushDefault:function(){this.push("$page_view")},push:function(t,e){if(!this.eventPusher)throw new Error(this.context+" is not initialized, call "+this.context+".init(YOUR_TOKEN) first !");this.eventPusher.push(t,e)},addProperty:function(t,e){this.console.debug("addProperty",t,e);var i={};i[t]=e,this.addProperties(i)},addProperties:function(t){this.console.debug("addProperties",t),this.eventPusher?this.eventPusher.addProperties(t):this.globalProperties=n(this.globalProperties,t)},_reset:function(){this.console.info("reset ",this.context),this.set=!1,this.options=n({debug:this.options.debug},d),this.globalProperties={$sv:l._snippetVersion},this.cookieMatcher=null,this.eventPusher=null,this.currentPage=null},config:function(t){return t=t||{},this.options=n(this.options,t),t.cookie_matching_url?this.console.info("overriding cookie_matching_url with ",t.cookie_matching_url):t.domain_name&&(this.options.cookie_matching_url=this.options.protocol+this.options.domain_name+this.options.get_id_path,this.console.info("using custom domain, cookie_matching_url will be ",this.options.cookie_matching_url)),this.console.info("mcsObj.config, new configuration is",this.options),this.options},syncFeeds:function(t){u.processExternalFeeds({period:this.globalProperties.$audience_feeds_refresh_period,site_token:this.options.site_token,domain_name:this.options.domain_name,callback:t})},_externalFeeds:u,_loaders:c}}()},function(t,e,i){!function(e){"use strict";t.exports={processExternalFeeds:function(t){o({s:window.localStorage?localStorage:{setItem:function(t,e){},getItem:function(t){return null}},hc:i(4),c:Date,p:t.period,st:t.site_token,dn:t.domain_name,cb:t.callback})},processExternalFeedsWith:o};var n=864e5;function o(t){t=function(t){return{s:t.s,hc:t.hc,c:t.c,p:t.p?t.p:n,st:t.st,dn:t.dn,cb:function(t){if(t&&"function"==typeof t)return t;return function(t,e){}}(t.cb)}}(t);var e=JSON.parse(t.s.getItem("_mediarithmics")),i=(e=e||{})[t.st];(!i||t.c.now()-i.lastFeedRefreshDate>t.p)&&t.hc.get("https://"+t.dn+"/v1/sites/"+t.st+"/external_feeds",function(i,n){if(i)t.cb(i,null);else{var o=JSON.parse(n);e[t.st]={lastFeedRefreshDate:t.c.now()},t.s.setItem("_mediarithmics",JSON.stringify(e)),o.scripts.map(function(e){var i;"INLINE"===e.type?((i=document.createElement("script"))[void 0===i.innerText?"textContent":"innerText"]=e.inner,document.head.appendChild(i)):"SRC"===e.type?((i=document.createElement("script")).src=e.source,document.head.appendChild(i)):"IMG"===e.type&&t.hc.loadPixel(e.source,void 0)}),t.cb(null,o.feeds)}})}}()}]);